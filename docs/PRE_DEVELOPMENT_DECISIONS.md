# 開発前決定事項

このドキュメントは、musix.js の実装を開始する前に決定すべき事項をまとめたものです。

## ステータス

- [ ] 1. 技術スタック・環境設定
- [ ] 2. パッケージ設計
- [ ] 3. APIデザイン
- [ ] 4. アーキテクチャ詳細
- [ ] 5. 開発プロセス

---

## 1. 技術スタック・環境設定

| 項目 | 選択肢 | 決定 |
|------|--------|------|
| ランタイム | Node.js / Bun | **Bun** |
| モジュール形式 | ESM / CommonJS / デュアル | |
| バンドラー | tsup / tsdown / Rollup / esbuild / Bunup | **tsdown** |
| TypeScriptターゲット | ES2020 / ES2022 / ESNext | |
| テストフレームワーク | Vitest（詳細設定） | |
| リンター/フォーマッター | ESLint + Prettier ルール | |

### 検討メモ

<!-- 各項目の検討内容をここに記載 -->

---

## 2. パッケージ設計

| 項目 | 選択肢 | 決定 |
|------|--------|------|
| パッケージ名 | `musix.js` / `musix` / `@musix/core` | |
| 公開スコープ | public / private / scoped | |
| エントリーポイント | 単一 / サブパスエクスポート | |
| 依存関係方針 | 最小化 / 利便性重視 | |

### 検討メモ

<!-- 各項目の検討内容をここに記載 -->

---

## 3. APIデザイン

| 項目 | 選択肢 | 決定 |
|------|--------|------|
| 初期対応サービス | Spotify / Apple Music / YouTube Music | **Spotify** |
| 認証フローの扱い | ライブラリ内処理 / トークンのみ受取 | **トークンのみ受取** |
| 非同期パターン | Promise / AsyncIterator / Observable | **Promise + AsyncIterator** |
| エラーハンドリング | カスタムエラー / Result型 / 例外 | **カスタムエラー** |
| ページネーション | カーソル / オフセット / AsyncIterator | **AsyncIterator + カーソル** |

### 検討メモ

<!-- 各項目の検討内容をここに記載 -->

---

## 4. アーキテクチャ詳細

| 項目 | 選択肢 | 決定 |
|------|--------|------|
| アダプター登録方法 | 手動登録 / 自動検出 / DIコンテナ | |
| 共通インターフェース | 別途仕様書で定義 | |
| サービス間ID変換 | ISRC / 検索ベース / 外部サービス | |
| キャッシュ戦略 | なし / メモリ / プラガブル | |
| レート制限対応 | 自動リトライ / エラー通知のみ | |

### 検討メモ

<!-- 各項目の検討内容をここに記載 -->

---

## 5. 開発プロセス

| 項目 | 選択肢 | 決定 |
|------|--------|------|
| ブランチ戦略 | Git Flow / GitHub Flow / Trunk-based | |
| バージョニング | SemVer ルール | |
| CI/CD | GitHub Actions 設定 | |
| ドキュメント生成 | TypeDoc / VitePress / なし | |
| 変更履歴管理 | CHANGELOG / Conventional Commits | |

### 検討メモ

<!-- 各項目の検討内容をここに記載 -->

---

## 決定履歴

| 日付 | 項目 | 決定内容 | 理由 |
|------|------|----------|------|
| 2025-12-02 | 初期対応サービス | Spotify | 公式TypeScript SDKが充実、無料で開始可能、基本機能（検索・プレイリスト・再生制御）は利用可能。2024年11月の制限（Recommendations等）を理解した上で共通インターフェースを設計できる |
| 2025-12-02 | 認証フローの扱い | トークンのみ受取 | シンプルに開始、環境非依存、責務分離。将来的に認証ヘルパーを追加してユーザー負担を減らす可能性あり |
| 2025-12-02 | 非同期パターン | Promise + AsyncIterator | 単一リソースはPromise、リスト取得はAsyncIteratorで逐次処理。シンプルかつメモリ効率が良い |
| 2025-12-02 | エラーハンドリング | カスタムエラー | 標準的なパターン、instanceof判定可、TypeScriptユーザーに馴染み深い |
| 2025-12-02 | ページネーション | AsyncIterator + カーソル | 高レベルAPIはAsyncIteratorで簡潔に、必要に応じてカーソルで細かく制御可能 |
| 2025-12-04 | ランタイム | Bun | 開発環境のみの影響、高速、TypeScriptネイティブ対応。tsdownはNAPI-RS経由でRolldownを使用するが、BunはNAPI-RSをほぼ完全サポート（2025年時点） |
| 2025-12-04 | バンドラー | tsdown | VoidZero社（Vite/Rolldown）がバック、Rolldownベースで高速、tsup互換で移行容易、活発にメンテ。Bunでの動作は実験的だがNAPI-RS互換により技術的障壁は低い |

---

## 次のステップ

1. 各セクションの項目について検討・決定する
2. 決定した内容を「決定」列に記入する
3. 全項目が決定したら、最初の仕様書（共通インターフェース）を作成する
