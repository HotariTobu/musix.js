# 開発前決定事項

このドキュメントは、musix.js の実装を開始する前に決定すべき事項をまとめたものです。

## ステータス

- [x] 1. 技術スタック・環境設定
- [x] 2. パッケージ設計
- [x] 3. APIデザイン
- [x] 4. 開発プロセス

---

## 1. 技術スタック・環境設定

| 項目 | 選択肢 | 決定 |
|------|--------|------|
| ランタイム | Node.js / Bun | **Bun** |
| モジュール形式 | ESM / CommonJS / デュアル | **デュアル** |
| バンドラー | tsup / tsdown / Rollup / esbuild / Bunup | **tsdown** |
| TypeScriptターゲット | ES2020 / ES2022 / ESNext | **ESNext** |
| テストフレームワーク | Vitest / Bun Test | **Bun Test** |
| リンター/フォーマッター | ESLint + Prettier / Biome | **Biome** |

### 検討メモ

<!-- 各項目の検討内容をここに記載 -->

---

## 2. パッケージ設計

| 項目 | 選択肢 | 決定 |
|------|--------|------|
| パッケージ名 | `musix.js` / `musix` / `@musix/core` | **musix** |
| 公開スコープ | public / private / scoped | **public** |
| エントリーポイント | 単一 / サブパスエクスポート | **サブパスエクスポート** |
| 依存関係方針 | 最小化 / 利便性重視 | **最小化** |
| ディレクトリ構造 | フラット / 機能別 / アダプター中心 | **アダプター中心** |

### ディレクトリ構造

```
src/
├── core/       # 共通型、エラー、インターフェース
└── adapters/   # 各サービスのアダプター
    ├── spotify/
    ├── apple-music/
    └── youtube-music/
```

### 検討メモ

<!-- 各項目の検討内容をここに記載 -->

---

## 3. APIデザイン

| 項目 | 選択肢 | 決定 |
|------|--------|------|
| 初期対応サービス | Spotify / Apple Music / YouTube Music | **Spotify** |
| 認証フローの扱い | ライブラリ内処理 / トークンのみ受取 | **トークンのみ受取** |
| 非同期パターン | Promise / AsyncIterator / Observable | **Promise + AsyncIterator** |
| エラーハンドリング | カスタムエラー / Result型 / 例外 | **カスタムエラー** |
| ページネーション | カーソル / オフセット / AsyncIterator | **AsyncIterator + カーソル** |

### 検討メモ

<!-- 各項目の検討内容をここに記載 -->

---

## 4. 開発プロセス

| 項目 | 選択肢 | 決定 |
|------|--------|------|
| ブランチ戦略 | Git Flow / GitHub Flow / Trunk-based | **GitHub Flow** |
| バージョニング | SemVer ルール | **SemVer** |
| CI/CD | GitHub Actions 設定 | **GitHub Actions** |
| ドキュメント生成 | TypeDoc / VitePress / なし | **TypeDoc** |
| 変更履歴管理 | CHANGELOG / Conventional Commits | **Conventional Commits** |

### 検討メモ

<!-- 各項目の検討内容をここに記載 -->

---

## 決定履歴

| 日付 | 項目 | 決定内容 | 理由 |
|------|------|----------|------|
| 2025-12-02 | 初期対応サービス | Spotify | 公式TypeScript SDKが充実、無料で開始可能、基本機能（検索・プレイリスト・再生制御）は利用可能。2024年11月の制限（Recommendations等）を理解した上で共通インターフェースを設計できる |
| 2025-12-02 | 認証フローの扱い | トークンのみ受取 | シンプルに開始、環境非依存、責務分離。将来的に認証ヘルパーを追加してユーザー負担を減らす可能性あり |
| 2025-12-02 | 非同期パターン | Promise + AsyncIterator | 単一リソースはPromise、リスト取得はAsyncIteratorで逐次処理。シンプルかつメモリ効率が良い |
| 2025-12-02 | エラーハンドリング | カスタムエラー | 標準的なパターン、instanceof判定可、TypeScriptユーザーに馴染み深い |
| 2025-12-02 | ページネーション | AsyncIterator + カーソル | 高レベルAPIはAsyncIteratorで簡潔に、必要に応じてカーソルで細かく制御可能 |
| 2025-12-04 | ランタイム | Bun | 開発環境のみの影響、高速、TypeScriptネイティブ対応。tsdownはNAPI-RS経由でRolldownを使用するが、BunはNAPI-RSをほぼ完全サポート（2025年時点） |
| 2025-12-04 | バンドラー | tsdown | VoidZero社（Vite/Rolldown）がバック、Rolldownベースで高速、tsup互換で移行容易、活発にメンテ。Bunでの動作は実験的だがNAPI-RS互換により技術的障壁は低い |
| 2025-12-04 | モジュール形式 | デュアル | ESM/CJS両対応で幅広い環境をサポート |
| 2025-12-04 | TypeScriptターゲット | ESNext | 後から変更可能、最新構文を使用 |
| 2025-12-04 | リンター/フォーマッター | Biome | 高速、リンターとフォーマッターが統一、設定が簡単 |
| 2025-12-04 | テストフレームワーク | Bun Test | 高速、Bun環境との統一、APIモック中心のテストには十分。Fake Timersは不完全だが本ライブラリでは不要。必要になれば将来移行可能 |
| 2025-12-04 | パッケージ名 | musix | シンプルで覚えやすい |
| 2025-12-04 | 公開スコープ | public | npmに公開 |
| 2025-12-04 | エントリーポイント | サブパスエクスポート | 各アダプターを個別にimport可能、バンドルサイズ削減、依存関係分離 |
| 2025-12-04 | 依存関係方針 | 最小化 | 外部依存を極力減らし、軽量なライブラリを維持 |
| 2025-12-04 | ブランチ戦略 | GitHub Flow | シンプル、PRベースの開発 |
| 2025-12-04 | バージョニング | SemVer | 標準的なバージョニング規則 |
| 2025-12-04 | CI/CD | GitHub Actions | テスト・ビルド・公開の自動化 |
| 2025-12-04 | 変更履歴管理 | Conventional Commits | コミットメッセージの規則化、自動CHANGELOG生成可能 |
| 2025-12-04 | ドキュメント生成 | TypeDoc | TSDocからの自動生成で最も人気（GitHub Stars 8,300+、週240万DL）、設定がシンプル、単体でHTMLサイト生成可能、プラグインエコシステムが豊富 |
| 2025-12-04 | ディレクトリ構造 | アダプター中心 | `src/core/` に共通定義、`src/adapters/` に各サービス実装。ファイル構成は実装しながら決定 |

---

## 次のステップ

全ての事前決定事項が完了しました。最初の仕様書（共通インターフェース）を作成してください。
